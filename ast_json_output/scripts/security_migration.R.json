[
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "=== TDMx Security Migration Script ===\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "This script will:\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "1. Check environment variables\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "2. Migrate plaintext passwords to hashes\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "3. Verify audit chain integrity\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "4. Test authentication\n\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "source",
    "args": [
      {
        "type": "literal",
        "value": "../R/auth.R"
      }
    ]
  },
  {
    "type": "call",
    "fun": "source",
    "args": [
      {
        "type": "literal",
        "value": "../R/audit.R"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "Step 1: Checking environment variables...\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "check_env"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "TRUE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "val"
                  },
                  {
                    "type": "call",
                    "fun": "Sys.getenv",
                    "args": [
                      {
                        "type": "name",
                        "value": "var_name"
                      },
                      {
                        "type": "literal",
                        "value": ""
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "nzchar",
                    "args": [
                      {
                        "type": "name",
                        "value": "val"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "cat",
                        "args": [
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "  ✓ %s is set\n"
                              },
                              {
                                "type": "name",
                                "value": "var_name"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": true
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "name",
                        "value": "required"
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "  ✗ %s is NOT set (REQUIRED)\n"
                                  },
                                  {
                                    "type": "name",
                                    "value": "var_name"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "literal",
                                "value": false
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "  ⚠ %s is not set (optional)\n"
                                  },
                                  {
                                    "type": "name",
                                    "value": "var_name"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "literal",
                                "value": true
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "env_ok"
      },
      {
        "type": "literal",
        "value": true
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "env_ok"
      },
      {
        "type": "call",
        "fun": "&&",
        "args": [
          {
            "type": "call",
            "fun": "check_env",
            "args": {
              "1": {
                "type": "literal",
                "value": "AUDIT_HMAC_KEY"
              },
              "required": {
                "type": "literal",
                "value": true
              }
            }
          },
          {
            "type": "name",
            "value": "env_ok"
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "!",
        "args": [
          {
            "type": "name",
            "value": "env_ok"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "\n❌ Missing required environment variables!\n"
              }
            ]
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "Generate AUDIT_HMAC_KEY with: openssl rand -hex 32\n"
              }
            ]
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "Add to your .env file or export in shell\n"
              }
            ]
          },
          {
            "type": "call",
            "fun": "stop",
            "args": [
              {
                "type": "literal",
                "value": "Cannot proceed without required environment variables"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "check_env",
    "args": {
      "1": {
        "type": "literal",
        "value": "PGHOST"
      },
      "required": {
        "type": "literal",
        "value": false
      }
    }
  },
  {
    "type": "call",
    "fun": "check_env",
    "args": {
      "1": {
        "type": "literal",
        "value": "PGDATABASE"
      },
      "required": {
        "type": "literal",
        "value": false
      }
    }
  },
  {
    "type": "call",
    "fun": "check_env",
    "args": {
      "1": {
        "type": "literal",
        "value": "TDMX_JWT_SECRET"
      },
      "required": {
        "type": "literal",
        "value": false
      }
    }
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\nStep 2: Migrating passwords to hashes...\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "users_file"
      },
      {
        "type": "literal",
        "value": "config/users.yaml"
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "file.exists",
        "args": [
          {
            "type": "name",
            "value": "users_file"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "call",
                "fun": "sprintf",
                "args": [
                  {
                    "type": "literal",
                    "value": "  Found users file: %s\n"
                  },
                  {
                    "type": "name",
                    "value": "users_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "users"
              },
              {
                "type": "call",
                "fun": "credentials_load",
                "args": [
                  {
                    "type": "name",
                    "value": "users_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "has_plaintext"
              },
              {
                "type": "literal",
                "value": false
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "has_hashes"
              },
              {
                "type": "literal",
                "value": false
              }
            ]
          },
          {
            "type": "call",
            "fun": "for",
            "args": [
              {
                "type": "name",
                "value": "usr"
              },
              {
                "type": "call",
                "fun": "$",
                "args": [
                  {
                    "type": "name",
                    "value": "users"
                  },
                  {
                    "type": "name",
                    "value": "users"
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "usr"
                                  },
                                  {
                                    "type": "name",
                                    "value": "password"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "has_plaintext"
                              },
                              {
                                "type": "literal",
                                "value": true
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "  ⚠ User '%s' has plaintext password\n"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "usr"
                                      },
                                      {
                                        "type": "name",
                                        "value": "username"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "usr"
                                  },
                                  {
                                    "type": "name",
                                    "value": "password_hash"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "has_hashes"
                              },
                              {
                                "type": "literal",
                                "value": true
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "  ✓ User '%s' has password hash\n"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "usr"
                                      },
                                      {
                                        "type": "name",
                                        "value": "username"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "if",
            "args": [
              {
                "type": "name",
                "value": "has_plaintext"
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "\n  Plaintext passwords detected. Migrating...\n"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "<-",
                    "args": [
                      {
                        "type": "name",
                        "value": "response"
                      },
                      {
                        "type": "call",
                        "fun": "readline",
                        "args": [
                          {
                            "type": "literal",
                            "value": "  Migrate plaintext passwords to hashes? (y/n): "
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "==",
                        "args": [
                          {
                            "type": "call",
                            "fun": "tolower",
                            "args": [
                              {
                                "type": "name",
                                "value": "response"
                              }
                            ]
                          },
                          {
                            "type": "literal",
                            "value": "y"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "if",
                            "args": [
                              {
                                "type": "call",
                                "fun": "auth_upgrade_hashes",
                                "args": {
                                  "1": {
                                    "type": "name",
                                    "value": "users_file"
                                  },
                                  "backup": {
                                    "type": "literal",
                                    "value": true
                                  }
                                }
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "  ✓ Passwords migrated successfully\n"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "sprintf",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "  Backup saved as: %s.bak\n"
                                          },
                                          {
                                            "type": "name",
                                            "value": "users_file"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "  No migration needed\n"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "literal",
                                "value": "  Migration skipped\n"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "has_hashes"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "cat",
                        "args": [
                          {
                            "type": "literal",
                            "value": "  ✓ All users already have hashed passwords\n"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "cat",
                        "args": [
                          {
                            "type": "literal",
                            "value": "  No users found in configuration\n"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "call",
                "fun": "sprintf",
                "args": [
                  {
                    "type": "literal",
                    "value": "  Users file not found: %s\n"
                  },
                  {
                    "type": "name",
                    "value": "users_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "  Please create the file with user configurations\n"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\nStep 3: Checking audit chain integrity...\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "audit_file"
      },
      {
        "type": "literal",
        "value": "log/audit.csv"
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "file.exists",
        "args": [
          {
            "type": "name",
            "value": "audit_file"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "call",
                "fun": "sprintf",
                "args": [
                  {
                    "type": "literal",
                    "value": "  Found audit log: %s\n"
                  },
                  {
                    "type": "name",
                    "value": "audit_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "audit_data"
              },
              {
                "type": "call",
                "fun": ["::", "readr", "read_csv"],
                "args": {
                  "1": {
                    "type": "name",
                    "value": "audit_file"
                  },
                  "show_col_types": {
                    "type": "literal",
                    "value": false
                  }
                }
              }
            ]
          },
          {
            "type": "call",
            "fun": "if",
            "args": [
              {
                "type": "call",
                "fun": ">",
                "args": [
                  {
                    "type": "call",
                    "fun": "nrow",
                    "args": [
                      {
                        "type": "name",
                        "value": "audit_data"
                      }
                    ]
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "call",
                        "fun": "sprintf",
                        "args": [
                          {
                            "type": "literal",
                            "value": "  Audit log contains %d entries\n"
                          },
                          {
                            "type": "call",
                            "fun": "nrow",
                            "args": [
                              {
                                "type": "name",
                                "value": "audit_data"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "audit_verify_chain",
                        "args": [
                          {
                            "type": "name",
                            "value": "audit_file"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "literal",
                                "value": "  ✓ Audit chain integrity verified\n"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "literal",
                                "value": "  ✗ Audit chain integrity check failed\n"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "cat",
                            "args": [
                              {
                                "type": "literal",
                                "value": "  This is expected if migrating from non-HMAC to HMAC\n"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "archive_file"
                              },
                              {
                                "type": "call",
                                "fun": "paste0",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "audit_file"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "."
                                  },
                                  {
                                    "type": "call",
                                    "fun": "format",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "Sys.time",
                                        "args": []
                                      },
                                      {
                                        "type": "literal",
                                        "value": "%Y%m%d_%H%M%S"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "literal",
                                    "value": ".archive"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "response"
                              },
                              {
                                "type": "call",
                                "fun": "readline",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "  Archive old audit log and start fresh? (y/n): "
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "if",
                            "args": [
                              {
                                "type": "call",
                                "fun": "==",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "tolower",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "response"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "literal",
                                    "value": "y"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "file.rename",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "audit_file"
                                      },
                                      {
                                        "type": "name",
                                        "value": "archive_file"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "sprintf",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "  Archived to: %s\n"
                                          },
                                          {
                                            "type": "name",
                                            "value": "archive_file"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "audit_append_hashchain",
                                    "args": {
                                      "file": {
                                        "type": "name",
                                        "value": "audit_file"
                                      },
                                      "actor": {
                                        "type": "literal",
                                        "value": "system"
                                      },
                                      "action": {
                                        "type": "literal",
                                        "value": "security_migration"
                                      },
                                      "payload": {
                                        "type": "call",
                                        "fun": "list",
                                        "args": {
                                          "timestamp": {
                                            "type": "call",
                                            "fun": "Sys.time",
                                            "args": []
                                          },
                                          "old_audit_archived": {
                                            "type": "name",
                                            "value": "archive_file"
                                          },
                                          "hmac_enabled": {
                                            "type": "literal",
                                            "value": true
                                          }
                                        }
                                      }
                                    }
                                  },
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "  ✓ New HMAC-protected audit chain started\n"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "  Audit log is empty\n"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "  No existing audit log found\n"
              }
            ]
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "  Creating new HMAC-protected audit chain...\n"
              }
            ]
          },
          {
            "type": "call",
            "fun": "audit_append_hashchain",
            "args": {
              "file": {
                "type": "name",
                "value": "audit_file"
              },
              "actor": {
                "type": "literal",
                "value": "system"
              },
              "action": {
                "type": "literal",
                "value": "security_migration"
              },
              "payload": {
                "type": "call",
                "fun": "list",
                "args": {
                  "timestamp": {
                    "type": "call",
                    "fun": "Sys.time",
                    "args": []
                  },
                  "hmac_enabled": {
                    "type": "literal",
                    "value": true
                  },
                  "migration_run": {
                    "type": "literal",
                    "value": true
                  }
                }
              }
            }
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "  ✓ New HMAC-protected audit chain created\n"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\nStep 4: Testing authentication system...\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "file.exists",
        "args": [
          {
            "type": "name",
            "value": "users_file"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "users"
              },
              {
                "type": "call",
                "fun": "credentials_load",
                "args": [
                  {
                    "type": "name",
                    "value": "users_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "if",
            "args": [
              {
                "type": "call",
                "fun": ">",
                "args": [
                  {
                    "type": "call",
                    "fun": "length",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "users"
                          },
                          {
                            "type": "name",
                            "value": "users"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "<-",
                    "args": [
                      {
                        "type": "name",
                        "value": "test_user"
                      },
                      {
                        "type": "call",
                        "fun": "[[",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "users"
                              },
                              {
                                "type": "name",
                                "value": "users"
                              }
                            ]
                          },
                          {
                            "type": "literal",
                            "value": 1
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "call",
                        "fun": "sprintf",
                        "args": [
                          {
                            "type": "literal",
                            "value": "  Testing with user: %s\n"
                          },
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "test_user"
                              },
                              {
                                "type": "name",
                                "value": "username"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "test_user"
                                  },
                                  {
                                    "type": "name",
                                    "value": "password"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "result"
                              },
                              {
                                "type": "call",
                                "fun": "auth_check",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "test_user"
                                      },
                                      {
                                        "type": "name",
                                        "value": "username"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "test_user"
                                      },
                                      {
                                        "type": "name",
                                        "value": "password"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "if",
                            "args": [
                              {
                                "type": "name",
                                "value": "result"
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "  ✗ SECURITY ISSUE: Plaintext password still accepted!\n"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "stop",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Security migration failed - plaintext passwords still work"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "cat",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "  ✓ Plaintext password correctly rejected\n"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "\n  To test login, run:\n"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "  auth_check(\"username\", \"your-password\")\n"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "  This should return TRUE if the password is correct\n"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "literal",
                "value": "  No users file found - skipping auth test\n"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\n=== Migration Summary ===\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "✓ Environment variables checked\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "file.exists",
        "args": [
          {
            "type": "name",
            "value": "users_file"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "users"
              },
              {
                "type": "call",
                "fun": "credentials_load",
                "args": [
                  {
                    "type": "name",
                    "value": "users_file"
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "n_users"
              },
              {
                "type": "call",
                "fun": "length",
                "args": [
                  {
                    "type": "call",
                    "fun": "$",
                    "args": [
                      {
                        "type": "name",
                        "value": "users"
                      },
                      {
                        "type": "name",
                        "value": "users"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "<-",
            "args": [
              {
                "type": "name",
                "value": "n_hashed"
              },
              {
                "type": "call",
                "fun": "sum",
                "args": [
                  {
                    "type": "call",
                    "fun": "sapply",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "users"
                          },
                          {
                            "type": "name",
                            "value": "users"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "function",
                        "args": [
                          {
                            "type": "pairlist",
                            "value": ""
                          },
                          {
                            "type": "call",
                            "fun": "!",
                            "args": [
                              {
                                "type": "call",
                                "fun": "is.null",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "u"
                                      },
                                      {
                                        "type": "name",
                                        "value": "password_hash"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "NULL",
                            "value": []
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "call",
            "fun": "cat",
            "args": [
              {
                "type": "call",
                "fun": "sprintf",
                "args": [
                  {
                    "type": "literal",
                    "value": "✓ Password migration: %d/%d users have hashed passwords\n"
                  },
                  {
                    "type": "name",
                    "value": "n_hashed"
                  },
                  {
                    "type": "name",
                    "value": "n_users"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "if",
    "args": [
      {
        "type": "call",
        "fun": "file.exists",
        "args": [
          {
            "type": "name",
            "value": "audit_file"
          }
        ]
      },
      {
        "type": "call",
        "fun": "{",
        "args": [
          {
            "type": "call",
            "fun": "if",
            "args": [
              {
                "type": "call",
                "fun": "audit_verify_chain",
                "args": [
                  {
                    "type": "name",
                    "value": "audit_file"
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "✓ Audit chain uses HMAC integrity protection\n"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "{",
                "args": [
                  {
                    "type": "call",
                    "fun": "cat",
                    "args": [
                      {
                        "type": "literal",
                        "value": "⚠ Audit chain needs attention (see above)\n"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\n=== Next Steps ===\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "1. Ensure AUDIT_HMAC_KEY is set in production environment\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "2. Test user logins with their original passwords\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "3. Monitor audit logs for any issues\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "4. Remove any backup files after confirming system works\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "5. Document the HMAC key securely (password manager)\n"
      }
    ]
  },
  {
    "type": "call",
    "fun": "cat",
    "args": [
      {
        "type": "literal",
        "value": "\n✅ Security migration complete!\n"
      }
    ]
  }
]
