[
  {
    "type": "call",
    "fun": "library",
    "args": [
      {
        "type": "name",
        "value": "jsonlite"
      }
    ]
  },
  {
    "type": "call",
    "fun": "library",
    "args": [
      {
        "type": "name",
        "value": "digest"
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "FALLBACK_CONFIG"
      },
      {
        "type": "call",
        "fun": "list",
        "args": {
          "max_retries": {
            "type": "literal",
            "value": 3
          },
          "retry_delay_seconds": {
            "type": "literal",
            "value": 2
          },
          "emergency_dir": {
            "type": "literal",
            "value": "audit/emergency"
          },
          "backup_dir": {
            "type": "literal",
            "value": "audit/backup"
          },
          "remote_syslog_host": {
            "type": "call",
            "fun": "Sys.getenv",
            "args": [
              {
                "type": "literal",
                "value": "SYSLOG_HOST"
              },
              {
                "type": "literal",
                "value": ""
              }
            ]
          },
          "remote_syslog_port": {
            "type": "call",
            "fun": "as.integer",
            "args": [
              {
                "type": "call",
                "fun": "Sys.getenv",
                "args": [
                  {
                    "type": "literal",
                    "value": "SYSLOG_PORT"
                  },
                  {
                    "type": "literal",
                    "value": 514
                  }
                ]
              }
            ]
          },
          "email_alerts": {
            "type": "call",
            "fun": "as.logical",
            "args": [
              {
                "type": "call",
                "fun": "Sys.getenv",
                "args": [
                  {
                    "type": "literal",
                    "value": "AUDIT_EMAIL_ALERTS"
                  },
                  {
                    "type": "literal",
                    "value": false
                  }
                ]
              }
            ]
          },
          "email_recipient": {
            "type": "call",
            "fun": "Sys.getenv",
            "args": [
              {
                "type": "literal",
                "value": "AUDIT_EMAIL_RECIPIENT"
              },
              {
                "type": "literal",
                "value": "admin@example.com"
              }
            ]
          }
        }
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".init_fallback_system"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "dirs"
                  },
                  {
                    "type": "call",
                    "fun": "c",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "emergency_dir"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "log/fallback"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "for",
                "args": [
                  {
                    "type": "name",
                    "value": "dir"
                  },
                  {
                    "type": "name",
                    "value": "dirs"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "dir.create",
                        "args": {
                          "1": {
                            "type": "name",
                            "value": "dir"
                          },
                          "showWarnings": {
                            "type": "literal",
                            "value": false
                          },
                          "recursive": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "fallback_index"
                  },
                  {
                    "type": "call",
                    "fun": "file.path",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "fallback_index.json"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "file.exists",
                        "args": [
                          {
                            "type": "name",
                            "value": "fallback_index"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "index_data"
                          },
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "created": {
                                "type": "call",
                                "fun": "Sys.time",
                                "args": []
                              },
                              "entries": {
                                "type": "call",
                                "fun": "list",
                                "args": []
                              },
                              "last_sync": {
                                "type": "NULL",
                                "value": []
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "call",
                            "fun": "toJSON",
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "index_data"
                              },
                              "pretty": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          {
                            "type": "name",
                            "value": "fallback_index"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "audit_fallback_cascade"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": ".init_fallback_system",
                "args": []
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "level1_result"
                  },
                  {
                    "type": "call",
                    "fun": ".fallback_level1_db_retry",
                    "args": [
                      {
                        "type": "name",
                        "value": "event_data"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "$",
                    "args": [
                      {
                        "type": "name",
                        "value": "level1_result"
                      },
                      {
                        "type": "name",
                        "value": "success"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "name",
                            "value": "level1_result"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "level2_result"
                  },
                  {
                    "type": "call",
                    "fun": ".fallback_level2_local_storage",
                    "args": [
                      {
                        "type": "name",
                        "value": "event_data"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "level2_result"
                          },
                          {
                            "type": "name",
                            "value": "success"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "level3_result"
                          },
                          {
                            "type": "call",
                            "fun": ".fallback_level3_emergency_file",
                            "args": [
                              {
                                "type": "name",
                                "value": "event_data"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "==",
                            "args": [
                              {
                                "type": "call",
                                "fun": "[",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "Sys.info",
                                    "args": []
                                  },
                                  {
                                    "type": "literal",
                                    "value": "sysname"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": "Linux"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": ".fallback_level4_system_journal",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": ">",
                            "args": [
                              {
                                "type": "call",
                                "fun": "nchar",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "FALLBACK_CONFIG"
                                      },
                                      {
                                        "type": "name",
                                        "value": "remote_syslog_host"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": 0
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": ".fallback_level5_remote_syslog",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "FALLBACK_CONFIG"
                              },
                              {
                                "type": "name",
                                "value": "email_alerts"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": ".fallback_level6_email_alert",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "success": {
                        "type": "call",
                        "fun": "||",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "level2_result"
                              },
                              {
                                "type": "name",
                                "value": "success"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "level3_result"
                              },
                              {
                                "type": "name",
                                "value": "success"
                              }
                            ]
                          }
                        ]
                      },
                      "fallback_level": {
                        "type": "call",
                        "fun": "ifelse",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "level2_result"
                              },
                              {
                                "type": "name",
                                "value": "success"
                              }
                            ]
                          },
                          {
                            "type": "literal",
                            "value": 2
                          },
                          {
                            "type": "literal",
                            "value": 3
                          }
                        ]
                      },
                      "details": {
                        "type": "literal",
                        "value": "Event stored in fallback system"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level1_db_retry"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "for",
                "args": [
                  {
                    "type": "name",
                    "value": "attempt"
                  },
                  {
                    "type": "call",
                    "fun": ":",
                    "args": [
                      {
                        "type": "literal",
                        "value": 1
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "max_retries"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "result"
                          },
                          {
                            "type": "call",
                            "fun": "tryCatch",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "<-",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "con"
                                      },
                                      {
                                        "type": "call",
                                        "fun": ["::", "DBI", "dbConnect"],
                                        "args": {
                                          "1": {
                                            "type": "call",
                                            "fun": ["::", "RPostgres", "Postgres"],
                                            "args": []
                                          },
                                          "dbname": {
                                            "type": "call",
                                            "fun": "Sys.getenv",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "PG_DB"
                                              },
                                              {
                                                "type": "literal",
                                                "value": "tdmx_audit"
                                              }
                                            ]
                                          },
                                          "host": {
                                            "type": "call",
                                            "fun": "Sys.getenv",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "PG_HOST"
                                              },
                                              {
                                                "type": "literal",
                                                "value": "localhost"
                                              }
                                            ]
                                          },
                                          "port": {
                                            "type": "call",
                                            "fun": "as.integer",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "Sys.getenv",
                                                "args": [
                                                  {
                                                    "type": "literal",
                                                    "value": "PG_PORT"
                                                  },
                                                  {
                                                    "type": "literal",
                                                    "value": 5432
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          "user": {
                                            "type": "call",
                                            "fun": "Sys.getenv",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "PG_USER"
                                              },
                                              {
                                                "type": "literal",
                                                "value": "audit_user"
                                              }
                                            ]
                                          },
                                          "password": {
                                            "type": "call",
                                            "fun": "Sys.getenv",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "PG_PASS"
                                              },
                                              {
                                                "type": "literal",
                                                "value": ""
                                              }
                                            ]
                                          },
                                          "connect_timeout": {
                                            "type": "literal",
                                            "value": 5
                                          }
                                        }
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "on.exit",
                                    "args": {
                                      "1": {
                                        "type": "call",
                                        "fun": "try",
                                        "args": {
                                          "1": {
                                            "type": "call",
                                            "fun": ["::", "DBI", "dbDisconnect"],
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "con"
                                              }
                                            ]
                                          },
                                          "silent": {
                                            "type": "literal",
                                            "value": true
                                          }
                                        }
                                      },
                                      "add": {
                                        "type": "literal",
                                        "value": true
                                      }
                                    }
                                  },
                                  {
                                    "type": "call",
                                    "fun": "<-",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "query"
                                      },
                                      {
                                        "type": "literal",
                                        "value": "INSERT INTO audit_log (timestamp, actor, action, payload, hash, prev_hash, retry_attempt) \n                VALUES ($1, $2, $3, $4, $5, $6, $7)"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": ["::", "DBI", "dbExecute"],
                                    "args": {
                                      "1": {
                                        "type": "name",
                                        "value": "con"
                                      },
                                      "2": {
                                        "type": "name",
                                        "value": "query"
                                      },
                                      "params": {
                                        "type": "call",
                                        "fun": "list",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "timestamp"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "actor"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "action"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "payload"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "hash"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "prev_hash"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "name",
                                            "value": "attempt"
                                          }
                                        ]
                                      }
                                    }
                                  },
                                  {
                                    "type": "call",
                                    "fun": ".log_fallback_event",
                                    "args": {
                                      "1": {
                                        "type": "call",
                                        "fun": "sprintf",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "DB write successful on attempt %d/%d for hash: %s"
                                          },
                                          {
                                            "type": "name",
                                            "value": "attempt"
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "FALLBACK_CONFIG"
                                              },
                                              {
                                                "type": "name",
                                                "value": "max_retries"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "event_data"
                                              },
                                              {
                                                "type": "name",
                                                "value": "hash"
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      "level": {
                                        "type": "literal",
                                        "value": "INFO"
                                      }
                                    }
                                  },
                                  {
                                    "type": "call",
                                    "fun": "return",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "list",
                                        "args": {
                                          "success": {
                                            "type": "literal",
                                            "value": true
                                          },
                                          "attempt": {
                                            "type": "name",
                                            "value": "attempt"
                                          }
                                        }
                                      }
                                    ]
                                  }
                                ]
                              },
                              "error": {
                                "type": "call",
                                "fun": "function",
                                "args": [
                                  {
                                    "type": "pairlist",
                                    "value": ""
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "if",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "<",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "attempt"
                                              },
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "FALLBACK_CONFIG"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "max_retries"
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "{",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "Sys.sleep",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "*",
                                                    "args": [
                                                      {
                                                        "type": "call",
                                                        "fun": "$",
                                                        "args": [
                                                          {
                                                            "type": "name",
                                                            "value": "FALLBACK_CONFIG"
                                                          },
                                                          {
                                                            "type": "name",
                                                            "value": "retry_delay_seconds"
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "type": "call",
                                                        "fun": "(",
                                                        "args": [
                                                          {
                                                            "type": "call",
                                                            "fun": "^",
                                                            "args": [
                                                              {
                                                                "type": "literal",
                                                                "value": 2
                                                              },
                                                              {
                                                                "type": "call",
                                                                "fun": "(",
                                                                "args": [
                                                                  {
                                                                    "type": "call",
                                                                    "fun": "-",
                                                                    "args": [
                                                                      {
                                                                        "type": "name",
                                                                        "value": "attempt"
                                                                      },
                                                                      {
                                                                        "type": "literal",
                                                                        "value": 1
                                                                      }
                                                                    ]
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": ".log_fallback_event",
                                        "args": {
                                          "1": {
                                            "type": "call",
                                            "fun": "sprintf",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "DB retry %d/%d failed: %s"
                                              },
                                              {
                                                "type": "name",
                                                "value": "attempt"
                                              },
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "FALLBACK_CONFIG"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "max_retries"
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "e"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "message"
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          "level": {
                                            "type": "literal",
                                            "value": "WARNING"
                                          }
                                        }
                                      },
                                      {
                                        "type": "call",
                                        "fun": "return",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "list",
                                            "args": {
                                              "success": {
                                                "type": "literal",
                                                "value": false
                                              },
                                              "error": {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "e"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "message"
                                                  }
                                                ]
                                              }
                                            }
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "result"
                              },
                              {
                                "type": "name",
                                "value": "success"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "result"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "success": {
                        "type": "literal",
                        "value": false
                      },
                      "error": {
                        "type": "literal",
                        "value": "All DB retries exhausted"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level2_local_storage"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "sqlite_path"
                          },
                          {
                            "type": "call",
                            "fun": "file.path",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "FALLBACK_CONFIG"
                                  },
                                  {
                                    "type": "name",
                                    "value": "backup_dir"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": "audit_fallback.sqlite"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "con"
                          },
                          {
                            "type": "call",
                            "fun": ["::", "DBI", "dbConnect"],
                            "args": [
                              {
                                "type": "call",
                                "fun": ["::", "RSQLite", "SQLite"],
                                "args": []
                              },
                              {
                                "type": "name",
                                "value": "sqlite_path"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "on.exit",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "try",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": ["::", "DBI", "dbDisconnect"],
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "con"
                                  }
                                ]
                              },
                              "silent": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          "add": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": ["::", "DBI", "dbExecute"],
                        "args": [
                          {
                            "type": "name",
                            "value": "con"
                          },
                          {
                            "type": "literal",
                            "value": "\n      CREATE TABLE IF NOT EXISTS audit_fallback (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        timestamp TEXT NOT NULL,\n        actor TEXT NOT NULL,\n        action TEXT NOT NULL,\n        payload TEXT,\n        hash TEXT UNIQUE NOT NULL,\n        prev_hash TEXT,\n        synced BOOLEAN DEFAULT FALSE,\n        created_at TEXT DEFAULT CURRENT_TIMESTAMP\n      )\n    "
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": ["::", "DBI", "dbExecute"],
                        "args": {
                          "1": {
                            "type": "name",
                            "value": "con"
                          },
                          "2": {
                            "type": "literal",
                            "value": "\n      INSERT OR IGNORE INTO audit_fallback \n      (timestamp, actor, action, payload, hash, prev_hash)\n      VALUES (?, ?, ?, ?, ?, ?)\n    "
                          },
                          "params": {
                            "type": "call",
                            "fun": "list",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "timestamp"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "actor"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "action"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "payload"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "prev_hash"
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": ".update_fallback_index",
                        "args": [
                          {
                            "type": "name",
                            "value": "event_data"
                          },
                          {
                            "type": "literal",
                            "value": "sqlite"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": ".log_fallback_event",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "Event stored in SQLite fallback: %s"
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              }
                            ]
                          },
                          "level": {
                            "type": "literal",
                            "value": "INFO"
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "storage": {
                                "type": "literal",
                                "value": "sqlite"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": ".fallback_to_json_storage",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_to_json_storage"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "json_file"
                          },
                          {
                            "type": "call",
                            "fun": "file.path",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "FALLBACK_CONFIG"
                                  },
                                  {
                                    "type": "name",
                                    "value": "backup_dir"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "audit_%s.json"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "format",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "Sys.Date",
                                        "args": []
                                      },
                                      {
                                        "type": "literal",
                                        "value": "%Y%m%d"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "file.exists",
                            "args": [
                              {
                                "type": "name",
                                "value": "json_file"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "existing_data"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "fromJSON",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "readLines",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "json_file"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "existing_data"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "list",
                                    "args": {
                                      "entries": {
                                        "type": "call",
                                        "fun": "list",
                                        "args": []
                                      }
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "existing_data"
                              },
                              {
                                "type": "name",
                                "value": "entries"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "append",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "existing_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "entries"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "list",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "existing_data"
                              },
                              {
                                "type": "name",
                                "value": "last_updated"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "Sys.time",
                            "args": []
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "call",
                            "fun": "toJSON",
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "existing_data"
                              },
                              "pretty": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          {
                            "type": "name",
                            "value": "json_file"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": ".update_fallback_index",
                        "args": [
                          {
                            "type": "name",
                            "value": "event_data"
                          },
                          {
                            "type": "literal",
                            "value": "json"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "storage": {
                                "type": "literal",
                                "value": "json"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": ".log_fallback_event",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "JSON storage failed: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "level": {
                                "type": "literal",
                                "value": "ERROR"
                              }
                            }
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "success": {
                                    "type": "literal",
                                    "value": false
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level3_emergency_file"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "emergency_file"
                          },
                          {
                            "type": "call",
                            "fun": "file.path",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "FALLBACK_CONFIG"
                                  },
                                  {
                                    "type": "name",
                                    "value": "emergency_dir"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "EMERGENCY_%s_%s.txt"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "format",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "Sys.time",
                                        "args": []
                                      },
                                      {
                                        "type": "literal",
                                        "value": "%Y%m%d_%H%M%S"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "substr",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "event_data"
                                          },
                                          {
                                            "type": "name",
                                            "value": "hash"
                                          }
                                        ]
                                      },
                                      {
                                        "type": "literal",
                                        "value": 1
                                      },
                                      {
                                        "type": "literal",
                                        "value": 8
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "content"
                          },
                          {
                            "type": "call",
                            "fun": "paste",
                            "args": {
                              "1": {
                                "type": "literal",
                                "value": "=== EMERGENCY AUDIT ENTRY ==="
                              },
                              "2": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Timestamp: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "timestamp"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "3": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Actor: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "actor"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "4": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Action: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "action"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "5": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Payload: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "payload"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "6": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Hash: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "hash"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "7": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Previous Hash: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "prev_hash"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "8": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Emergency File Created: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "Sys.time",
                                    "args": []
                                  }
                                ]
                              },
                              "9": {
                                "type": "literal",
                                "value": "=== END ==="
                              },
                              "sep": {
                                "type": "literal",
                                "value": "\n"
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "name",
                            "value": "content"
                          },
                          {
                            "type": "name",
                            "value": "emergency_file"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": ".log_fallback_event",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "Emergency file created: %s"
                              },
                              {
                                "type": "name",
                                "value": "emergency_file"
                              }
                            ]
                          },
                          "level": {
                            "type": "literal",
                            "value": "WARNING"
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "file": {
                                "type": "name",
                                "value": "emergency_file"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": ".log_fallback_event",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Emergency file creation failed: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "level": {
                                "type": "literal",
                                "value": "CRITICAL"
                              }
                            }
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "success": {
                                    "type": "literal",
                                    "value": false
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level4_system_journal"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!=",
                    "args": [
                      {
                        "type": "call",
                        "fun": "[",
                        "args": [
                          {
                            "type": "call",
                            "fun": "Sys.info",
                            "args": []
                          },
                          {
                            "type": "literal",
                            "value": "sysname"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "Linux"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": false
                              },
                              "error": {
                                "type": "literal",
                                "value": "Not on Linux"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "message"
                          },
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "AUDIT_FALLBACK actor=%s action=%s hash=%s"
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "actor"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "action"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "system2",
                        "args": {
                          "1": {
                            "type": "literal",
                            "value": "logger"
                          },
                          "args": {
                            "type": "call",
                            "fun": "c",
                            "args": [
                              {
                                "type": "literal",
                                "value": "-t"
                              },
                              {
                                "type": "literal",
                                "value": "tdmx_audit"
                              },
                              {
                                "type": "literal",
                                "value": "-p"
                              },
                              {
                                "type": "literal",
                                "value": "user.warning"
                              },
                              {
                                "type": "name",
                                "value": "message"
                              }
                            ]
                          },
                          "stdout": {
                            "type": "literal",
                            "value": false
                          },
                          "stderr": {
                            "type": "literal",
                            "value": false
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "method": {
                                "type": "literal",
                                "value": "syslog"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "success": {
                                    "type": "literal",
                                    "value": false
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level5_remote_syslog"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "==",
                    "args": [
                      {
                        "type": "call",
                        "fun": "nchar",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "FALLBACK_CONFIG"
                              },
                              {
                                "type": "name",
                                "value": "remote_syslog_host"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": 0
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": false
                              },
                              "error": {
                                "type": "literal",
                                "value": "No remote syslog configured"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "priority"
                          },
                          {
                            "type": "literal",
                            "value": 14
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "timestamp"
                          },
                          {
                            "type": "call",
                            "fun": "format",
                            "args": [
                              {
                                "type": "call",
                                "fun": "Sys.time",
                                "args": []
                              },
                              {
                                "type": "literal",
                                "value": "%b %d %H:%M:%S"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "hostname"
                          },
                          {
                            "type": "call",
                            "fun": "[",
                            "args": [
                              {
                                "type": "call",
                                "fun": "Sys.info",
                                "args": []
                              },
                              {
                                "type": "literal",
                                "value": "nodename"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "tag"
                          },
                          {
                            "type": "literal",
                            "value": "tdmx_audit"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "message"
                          },
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "<%d>%s %s %s: FALLBACK actor=%s action=%s hash=%s"
                              },
                              {
                                "type": "name",
                                "value": "priority"
                              },
                              {
                                "type": "name",
                                "value": "timestamp"
                              },
                              {
                                "type": "name",
                                "value": "hostname"
                              },
                              {
                                "type": "name",
                                "value": "tag"
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "actor"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "action"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "con"
                          },
                          {
                            "type": "call",
                            "fun": "socketConnection",
                            "args": {
                              "host": {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "FALLBACK_CONFIG"
                                  },
                                  {
                                    "type": "name",
                                    "value": "remote_syslog_host"
                                  }
                                ]
                              },
                              "port": {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "FALLBACK_CONFIG"
                                  },
                                  {
                                    "type": "name",
                                    "value": "remote_syslog_port"
                                  }
                                ]
                              },
                              "open": {
                                "type": "literal",
                                "value": "w"
                              },
                              "blocking": {
                                "type": "literal",
                                "value": false
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "on.exit",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "try",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "close",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "con"
                                  }
                                ]
                              },
                              "silent": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          "add": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "name",
                            "value": "message"
                          },
                          {
                            "type": "name",
                            "value": "con"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "method": {
                                "type": "literal",
                                "value": "remote_syslog"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "success": {
                                    "type": "literal",
                                    "value": false
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fallback_level6_email_alert"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "email_alerts"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": false
                              },
                              "error": {
                                "type": "literal",
                                "value": "Email alerts disabled"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "subject"
                          },
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "[CRITICAL] TDMx Audit Fallback: %s"
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "action"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "body"
                          },
                          {
                            "type": "call",
                            "fun": "paste",
                            "args": {
                              "1": {
                                "type": "literal",
                                "value": "Critical Audit Event Required Fallback Storage"
                              },
                              "2": {
                                "type": "literal",
                                "value": ""
                              },
                              "3": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Timestamp: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "timestamp"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "4": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Actor: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "actor"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "5": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Action: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "action"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "6": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Hash: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "event_data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "hash"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "7": {
                                "type": "literal",
                                "value": ""
                              },
                              "8": {
                                "type": "literal",
                                "value": "This event has been stored in the fallback system."
                              },
                              "9": {
                                "type": "literal",
                                "value": "Immediate attention required to restore primary audit storage."
                              },
                              "10": {
                                "type": "literal",
                                "value": ""
                              },
                              "11": {
                                "type": "literal",
                                "value": "-- TDMx Audit System"
                              },
                              "sep": {
                                "type": "literal",
                                "value": "\n"
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "==",
                            "args": [
                              {
                                "type": "call",
                                "fun": "[",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "Sys.info",
                                    "args": []
                                  },
                                  {
                                    "type": "literal",
                                    "value": "sysname"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": "Linux"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "mail_cmd"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "echo \"%s\" | mail -s \"%s\" %s"
                                      },
                                      {
                                        "type": "name",
                                        "value": "body"
                                      },
                                      {
                                        "type": "name",
                                        "value": "subject"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "FALLBACK_CONFIG"
                                          },
                                          {
                                            "type": "name",
                                            "value": "email_recipient"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "system",
                                "args": {
                                  "1": {
                                    "type": "name",
                                    "value": "mail_cmd"
                                  },
                                  "intern": {
                                    "type": "literal",
                                    "value": false
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "success": {
                                "type": "literal",
                                "value": true
                              },
                              "method": {
                                "type": "literal",
                                "value": "email_alert"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "success": {
                                    "type": "literal",
                                    "value": false
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".update_fallback_index"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", ""]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "index_file"
                  },
                  {
                    "type": "call",
                    "fun": "file.path",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "fallback_index.json"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "index_data"
                          },
                          {
                            "type": "call",
                            "fun": "fromJSON",
                            "args": [
                              {
                                "type": "call",
                                "fun": "readLines",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "index_file"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "entry"
                          },
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "hash": {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              },
                              "timestamp": {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "event_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "timestamp"
                                  }
                                ]
                              },
                              "storage": {
                                "type": "name",
                                "value": "storage_method"
                              },
                              "synced": {
                                "type": "literal",
                                "value": false
                              },
                              "added_at": {
                                "type": "call",
                                "fun": "Sys.time",
                                "args": []
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "index_data"
                              },
                              {
                                "type": "name",
                                "value": "entries"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "append",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "index_data"
                                  },
                                  {
                                    "type": "name",
                                    "value": "entries"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "list",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "index_data"
                              },
                              {
                                "type": "name",
                                "value": "last_updated"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "Sys.time",
                            "args": []
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "call",
                            "fun": "toJSON",
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "index_data"
                              },
                              "pretty": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          {
                            "type": "name",
                            "value": "index_file"
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": ".log_fallback_event",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Index update failed: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "level": {
                                "type": "literal",
                                "value": "WARNING"
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "sync_fallback_entries"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": ".init_fallback_system",
                "args": []
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "synced_count"
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "failed_count"
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "sqlite_result"
                  },
                  {
                    "type": "call",
                    "fun": ".sync_sqlite_fallback",
                    "args": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "synced_count"
                  },
                  {
                    "type": "call",
                    "fun": "+",
                    "args": [
                      {
                        "type": "name",
                        "value": "synced_count"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "sqlite_result"
                          },
                          {
                            "type": "name",
                            "value": "synced"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "failed_count"
                  },
                  {
                    "type": "call",
                    "fun": "+",
                    "args": [
                      {
                        "type": "name",
                        "value": "failed_count"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "sqlite_result"
                          },
                          {
                            "type": "name",
                            "value": "failed"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "json_result"
                  },
                  {
                    "type": "call",
                    "fun": ".sync_json_fallback",
                    "args": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "synced_count"
                  },
                  {
                    "type": "call",
                    "fun": "+",
                    "args": [
                      {
                        "type": "name",
                        "value": "synced_count"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "json_result"
                          },
                          {
                            "type": "name",
                            "value": "synced"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "failed_count"
                  },
                  {
                    "type": "call",
                    "fun": "+",
                    "args": [
                      {
                        "type": "name",
                        "value": "failed_count"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "json_result"
                          },
                          {
                            "type": "name",
                            "value": "failed"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": ">",
                    "args": [
                      {
                        "type": "name",
                        "value": "synced_count"
                      },
                      {
                        "type": "literal",
                        "value": 0
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": ".update_sync_status",
                        "args": []
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "message",
                "args": [
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "Fallback sync complete: %d synced, %d failed"
                      },
                      {
                        "type": "name",
                        "value": "synced_count"
                      },
                      {
                        "type": "name",
                        "value": "failed_count"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "synced": {
                        "type": "name",
                        "value": "synced_count"
                      },
                      "failed": {
                        "type": "name",
                        "value": "failed_count"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".sync_sqlite_fallback"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "sqlite_path"
                  },
                  {
                    "type": "call",
                    "fun": "file.path",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "audit_fallback.sqlite"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "file.exists",
                        "args": [
                          {
                            "type": "name",
                            "value": "sqlite_path"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "synced": {
                                "type": "literal",
                                "value": 0
                              },
                              "failed": {
                                "type": "literal",
                                "value": 0
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "con_sqlite"
                  },
                  {
                    "type": "NULL",
                    "value": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "con_pg"
                  },
                  {
                    "type": "NULL",
                    "value": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "con_sqlite"
                          },
                          {
                            "type": "call",
                            "fun": ["::", "DBI", "dbConnect"],
                            "args": [
                              {
                                "type": "call",
                                "fun": ["::", "RSQLite", "SQLite"],
                                "args": []
                              },
                              {
                                "type": "name",
                                "value": "sqlite_path"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "on.exit",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "try",
                                "args": {
                                  "1": {
                                    "type": "call",
                                    "fun": ["::", "DBI", "dbDisconnect"],
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "con_sqlite"
                                      }
                                    ]
                                  },
                                  "silent": {
                                    "type": "literal",
                                    "value": true
                                  }
                                }
                              },
                              {
                                "type": "call",
                                "fun": "if",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "!",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "is.null",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "con_pg"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "try",
                                        "args": {
                                          "1": {
                                            "type": "call",
                                            "fun": ["::", "DBI", "dbDisconnect"],
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "con_pg"
                                              }
                                            ]
                                          },
                                          "silent": {
                                            "type": "literal",
                                            "value": true
                                          }
                                        }
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          "add": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "unsynced"
                          },
                          {
                            "type": "call",
                            "fun": ["::", "DBI", "dbGetQuery"],
                            "args": [
                              {
                                "type": "name",
                                "value": "con_sqlite"
                              },
                              {
                                "type": "literal",
                                "value": "SELECT * FROM audit_fallback WHERE synced = FALSE ORDER BY id"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "synced"
                          },
                          {
                            "type": "literal",
                            "value": 0
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "failed"
                          },
                          {
                            "type": "literal",
                            "value": 0
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "for",
                        "args": [
                          {
                            "type": "name",
                            "value": "i"
                          },
                          {
                            "type": "call",
                            "fun": "seq_len",
                            "args": [
                              {
                                "type": "call",
                                "fun": "nrow",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "unsynced"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "[",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "unsynced"
                                      },
                                      {
                                        "type": "name",
                                        "value": "i"
                                      },
                                      {
                                        "type": "name",
                                        "value": ""
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "result"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "tryCatch",
                                    "args": {
                                      "1": {
                                        "type": "call",
                                        "fun": "{",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "<-",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "con_pg"
                                              },
                                              {
                                                "type": "call",
                                                "fun": ["::", "DBI", "dbConnect"],
                                                "args": {
                                                  "1": {
                                                    "type": "call",
                                                    "fun": ["::", "RPostgres", "Postgres"],
                                                    "args": []
                                                  },
                                                  "dbname": {
                                                    "type": "call",
                                                    "fun": "Sys.getenv",
                                                    "args": [
                                                      {
                                                        "type": "literal",
                                                        "value": "PG_DB"
                                                      },
                                                      {
                                                        "type": "literal",
                                                        "value": "tdmx_audit"
                                                      }
                                                    ]
                                                  },
                                                  "host": {
                                                    "type": "call",
                                                    "fun": "Sys.getenv",
                                                    "args": [
                                                      {
                                                        "type": "literal",
                                                        "value": "PG_HOST"
                                                      },
                                                      {
                                                        "type": "literal",
                                                        "value": "localhost"
                                                      }
                                                    ]
                                                  },
                                                  "port": {
                                                    "type": "call",
                                                    "fun": "as.integer",
                                                    "args": [
                                                      {
                                                        "type": "call",
                                                        "fun": "Sys.getenv",
                                                        "args": [
                                                          {
                                                            "type": "literal",
                                                            "value": "PG_PORT"
                                                          },
                                                          {
                                                            "type": "literal",
                                                            "value": 5432
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  "user": {
                                                    "type": "call",
                                                    "fun": "Sys.getenv",
                                                    "args": [
                                                      {
                                                        "type": "literal",
                                                        "value": "PG_USER"
                                                      },
                                                      {
                                                        "type": "literal",
                                                        "value": "audit_user"
                                                      }
                                                    ]
                                                  },
                                                  "password": {
                                                    "type": "call",
                                                    "fun": "Sys.getenv",
                                                    "args": [
                                                      {
                                                        "type": "literal",
                                                        "value": "PG_PASS"
                                                      },
                                                      {
                                                        "type": "literal",
                                                        "value": ""
                                                      }
                                                    ]
                                                  }
                                                }
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": ["::", "DBI", "dbExecute"],
                                            "args": {
                                              "1": {
                                                "type": "name",
                                                "value": "con_pg"
                                              },
                                              "2": {
                                                "type": "literal",
                                                "value": "INSERT INTO audit_log (timestamp, actor, action, payload, hash, prev_hash, from_fallback)\n           VALUES ($1, $2, $3, $4, $5, $6, TRUE)\n           ON CONFLICT (hash) DO NOTHING"
                                              },
                                              "params": {
                                                "type": "call",
                                                "fun": "list",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "timestamp"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "actor"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "action"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "payload"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "hash"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "prev_hash"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            }
                                          },
                                          {
                                            "type": "call",
                                            "fun": ["::", "DBI", "dbDisconnect"],
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "con_pg"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "<-",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "con_pg"
                                              },
                                              {
                                                "type": "NULL",
                                                "value": []
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": ["::", "DBI", "dbExecute"],
                                            "args": {
                                              "1": {
                                                "type": "name",
                                                "value": "con_sqlite"
                                              },
                                              "2": {
                                                "type": "literal",
                                                "value": "UPDATE audit_fallback SET synced = TRUE WHERE id = ?"
                                              },
                                              "params": {
                                                "type": "call",
                                                "fun": "list",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "id"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            }
                                          },
                                          {
                                            "type": "call",
                                            "fun": "<-",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "synced"
                                              },
                                              {
                                                "type": "call",
                                                "fun": "+",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "synced"
                                                  },
                                                  {
                                                    "type": "literal",
                                                    "value": 1
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            "type": "literal",
                                            "value": true
                                          }
                                        ]
                                      },
                                      "error": {
                                        "type": "call",
                                        "fun": "function",
                                        "args": [
                                          {
                                            "type": "pairlist",
                                            "value": ""
                                          },
                                          {
                                            "type": "call",
                                            "fun": "{",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "<-",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "failed"
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "+",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "failed"
                                                      },
                                                      {
                                                        "type": "literal",
                                                        "value": 1
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "literal",
                                                "value": false
                                              }
                                            ]
                                          },
                                          {
                                            "type": "NULL",
                                            "value": []
                                          }
                                        ]
                                      }
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "list",
                            "args": {
                              "synced": {
                                "type": "name",
                                "value": "synced"
                              },
                              "failed": {
                                "type": "name",
                                "value": "failed"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": ".log_fallback_event",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "SQLite sync failed: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "level": {
                                "type": "literal",
                                "value": "ERROR"
                              }
                            }
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "list",
                                "args": {
                                  "synced": {
                                    "type": "literal",
                                    "value": 0
                                  },
                                  "failed": {
                                    "type": "literal",
                                    "value": 0
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".sync_json_fallback"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "json_files"
                  },
                  {
                    "type": "call",
                    "fun": "list.files",
                    "args": {
                      "1": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      "pattern": {
                        "type": "literal",
                        "value": "^audit_.*\\.json$"
                      },
                      "full.names": {
                        "type": "literal",
                        "value": true
                      }
                    }
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "synced"
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "failed"
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "for",
                "args": [
                  {
                    "type": "name",
                    "value": "json_file"
                  },
                  {
                    "type": "name",
                    "value": "json_files"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "tryCatch",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "data"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "fromJSON",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "readLines",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "json_file"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "for",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "data"
                                      },
                                      {
                                        "type": "name",
                                        "value": "entries"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "if",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "||",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "is.null",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "synced"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "call",
                                                "fun": "!",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "synced"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "{",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "<-",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "result"
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": ".sync_single_entry",
                                                    "args": [
                                                      {
                                                        "type": "name",
                                                        "value": "entry"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "call",
                                                "fun": "if",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "result"
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "{",
                                                    "args": [
                                                      {
                                                        "type": "call",
                                                        "fun": "<-",
                                                        "args": [
                                                          {
                                                            "type": "name",
                                                            "value": "synced"
                                                          },
                                                          {
                                                            "type": "call",
                                                            "fun": "+",
                                                            "args": [
                                                              {
                                                                "type": "name",
                                                                "value": "synced"
                                                              },
                                                              {
                                                                "type": "literal",
                                                                "value": 1
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "type": "call",
                                                        "fun": "<-",
                                                        "args": [
                                                          {
                                                            "type": "call",
                                                            "fun": "$",
                                                            "args": [
                                                              {
                                                                "type": "name",
                                                                "value": "entry"
                                                              },
                                                              {
                                                                "type": "name",
                                                                "value": "synced"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "type": "literal",
                                                            "value": true
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "call",
                                                    "fun": "{",
                                                    "args": [
                                                      {
                                                        "type": "call",
                                                        "fun": "<-",
                                                        "args": [
                                                          {
                                                            "type": "name",
                                                            "value": "failed"
                                                          },
                                                          {
                                                            "type": "call",
                                                            "fun": "+",
                                                            "args": [
                                                              {
                                                                "type": "name",
                                                                "value": "failed"
                                                              },
                                                              {
                                                                "type": "literal",
                                                                "value": 1
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "writeLines",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "toJSON",
                                    "args": {
                                      "1": {
                                        "type": "name",
                                        "value": "data"
                                      },
                                      "pretty": {
                                        "type": "literal",
                                        "value": true
                                      }
                                    }
                                  },
                                  {
                                    "type": "name",
                                    "value": "json_file"
                                  }
                                ]
                              }
                            ]
                          },
                          "error": {
                            "type": "call",
                            "fun": "function",
                            "args": [
                              {
                                "type": "pairlist",
                                "value": ""
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": ".log_fallback_event",
                                    "args": {
                                      "1": {
                                        "type": "call",
                                        "fun": "sprintf",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "JSON sync failed for %s: %s"
                                          },
                                          {
                                            "type": "name",
                                            "value": "json_file"
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "e"
                                              },
                                              {
                                                "type": "name",
                                                "value": "message"
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      "level": {
                                        "type": "literal",
                                        "value": "WARNING"
                                      }
                                    }
                                  }
                                ]
                              },
                              {
                                "type": "NULL",
                                "value": []
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "synced": {
                        "type": "name",
                        "value": "synced"
                      },
                      "failed": {
                        "type": "name",
                        "value": "failed"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".sync_single_entry"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "con"
                  },
                  {
                    "type": "NULL",
                    "value": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "con"
                          },
                          {
                            "type": "call",
                            "fun": ["::", "DBI", "dbConnect"],
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": ["::", "RPostgres", "Postgres"],
                                "args": []
                              },
                              "dbname": {
                                "type": "call",
                                "fun": "Sys.getenv",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "PG_DB"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "tdmx_audit"
                                  }
                                ]
                              },
                              "host": {
                                "type": "call",
                                "fun": "Sys.getenv",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "PG_HOST"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "localhost"
                                  }
                                ]
                              },
                              "port": {
                                "type": "call",
                                "fun": "as.integer",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "Sys.getenv",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "PG_PORT"
                                      },
                                      {
                                        "type": "literal",
                                        "value": 5432
                                      }
                                    ]
                                  }
                                ]
                              },
                              "user": {
                                "type": "call",
                                "fun": "Sys.getenv",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "PG_USER"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "audit_user"
                                  }
                                ]
                              },
                              "password": {
                                "type": "call",
                                "fun": "Sys.getenv",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "PG_PASS"
                                  },
                                  {
                                    "type": "literal",
                                    "value": ""
                                  }
                                ]
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "on.exit",
                        "args": {
                          "1": {
                            "type": "call",
                            "fun": "try",
                            "args": {
                              "1": {
                                "type": "call",
                                "fun": ["::", "DBI", "dbDisconnect"],
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "con"
                                  }
                                ]
                              },
                              "silent": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          "add": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": ["::", "DBI", "dbExecute"],
                        "args": {
                          "1": {
                            "type": "name",
                            "value": "con"
                          },
                          "2": {
                            "type": "literal",
                            "value": "INSERT INTO audit_log (timestamp, actor, action, payload, hash, prev_hash, from_fallback)\n       VALUES ($1, $2, $3, $4, $5, $6, TRUE)\n       ON CONFLICT (hash) DO NOTHING"
                          },
                          "params": {
                            "type": "call",
                            "fun": "list",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "timestamp"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "actor"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "action"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "payload"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "hash"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  },
                                  {
                                    "type": "name",
                                    "value": "prev_hash"
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": true
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "literal",
                                "value": false
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".update_sync_status"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "index_file"
                  },
                  {
                    "type": "call",
                    "fun": "file.path",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "FALLBACK_CONFIG"
                          },
                          {
                            "type": "name",
                            "value": "backup_dir"
                          }
                        ]
                      },
                      {
                        "type": "literal",
                        "value": "fallback_index.json"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "index_data"
                          },
                          {
                            "type": "call",
                            "fun": "fromJSON",
                            "args": [
                              {
                                "type": "call",
                                "fun": "readLines",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "index_file"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "index_data"
                              },
                              {
                                "type": "name",
                                "value": "last_sync"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "Sys.time",
                            "args": []
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "writeLines",
                        "args": [
                          {
                            "type": "call",
                            "fun": "toJSON",
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "index_data"
                              },
                              "pretty": {
                                "type": "literal",
                                "value": true
                              }
                            }
                          },
                          {
                            "type": "name",
                            "value": "index_file"
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": []
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".log_fallback_event"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "INFO"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "log_file"
                  },
                  {
                    "type": "call",
                    "fun": "file.path",
                    "args": [
                      {
                        "type": "literal",
                        "value": "log/fallback"
                      },
                      {
                        "type": "call",
                        "fun": "sprintf",
                        "args": [
                          {
                            "type": "literal",
                            "value": "fallback_%s.log"
                          },
                          {
                            "type": "call",
                            "fun": "format",
                            "args": [
                              {
                                "type": "call",
                                "fun": "Sys.Date",
                                "args": []
                              },
                              {
                                "type": "literal",
                                "value": "%Y%m%d"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "log_entry"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "[%s] %s: %s"
                      },
                      {
                        "type": "call",
                        "fun": "format",
                        "args": [
                          {
                            "type": "call",
                            "fun": "Sys.time",
                            "args": []
                          },
                          {
                            "type": "literal",
                            "value": "%Y-%m-%d %H:%M:%S"
                          }
                        ]
                      },
                      {
                        "type": "name",
                        "value": "level"
                      },
                      {
                        "type": "name",
                        "value": "message"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "cat",
                        "args": {
                          "1": {
                            "type": "name",
                            "value": "log_entry"
                          },
                          "2": {
                            "type": "literal",
                            "value": "\n"
                          },
                          "file": {
                            "type": "name",
                            "value": "log_file"
                          },
                          "append": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "message",
                            "args": [
                              {
                                "type": "name",
                                "value": "log_entry"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "%||%"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", ""]
          },
          {
            "type": "call",
            "fun": "if",
            "args": [
              {
                "type": "call",
                "fun": "is.null",
                "args": [
                  {
                    "type": "name",
                    "value": "a"
                  }
                ]
              },
              {
                "type": "name",
                "value": "b"
              },
              {
                "type": "name",
                "value": "a"
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  }
]
