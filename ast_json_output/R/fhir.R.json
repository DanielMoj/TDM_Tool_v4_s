[
  {
    "type": "call",
    "fun": "source",
    "args": [
      {
        "type": "literal",
        "value": "fhir_connection.R"
      }
    ]
  },
  {
    "type": "call",
    "fun": "source",
    "args": [
      {
        "type": "literal",
        "value": "fhir_auth.R"
      }
    ]
  },
  {
    "type": "call",
    "fun": "source",
    "args": [
      {
        "type": "literal",
        "value": "fhir_cache.R"
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": ".fhir_config"
      },
      {
        "type": "call",
        "fun": "new.env",
        "args": {
          "parent": {
            "type": "call",
            "fun": "emptyenv",
            "args": []
          }
        }
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "call",
        "fun": "$",
        "args": [
          {
            "type": "name",
            "value": ".fhir_config"
          },
          {
            "type": "name",
            "value": "base_url"
          }
        ]
      },
      {
        "type": "call",
        "fun": "Sys.getenv",
        "args": [
          {
            "type": "literal",
            "value": "FHIR_BASE_URL"
          },
          {
            "type": "literal",
            "value": ""
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "call",
        "fun": "$",
        "args": [
          {
            "type": "name",
            "value": ".fhir_config"
          },
          {
            "type": "name",
            "value": "default_page_size"
          }
        ]
      },
      {
        "type": "literal",
        "value": 50
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "call",
        "fun": "$",
        "args": [
          {
            "type": "name",
            "value": ".fhir_config"
          },
          {
            "type": "name",
            "value": "max_pages"
          }
        ]
      },
      {
        "type": "literal",
        "value": 10
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "call",
        "fun": "$",
        "args": [
          {
            "type": "name",
            "value": ".fhir_config"
          },
          {
            "type": "name",
            "value": "timeout"
          }
        ]
      },
      {
        "type": "literal",
        "value": 30
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "init_fhir_client"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["NULL", "NULL", "NULL", "NULL", "TRUE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": ".fhir_config"
                              },
                              {
                                "type": "name",
                                "value": "base_url"
                              }
                            ]
                          },
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "call",
                            "fun": "Sys.getenv",
                            "args": [
                              {
                                "type": "literal",
                                "value": "FHIR_BASE_URL"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": ".fhir_config"
                                  },
                                  {
                                    "type": "name",
                                    "value": "base_url"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "Sys.getenv",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "FHIR_BASE_URL"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "stop",
                            "args": [
                              {
                                "type": "literal",
                                "value": "FHIR base URL must be provided or set in FHIR_BASE_URL environment variable"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "grepl",
                        "args": [
                          {
                            "type": "literal",
                            "value": "^https?://"
                          },
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": ".fhir_config"
                              },
                              {
                                "type": "name",
                                "value": "base_url"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "FHIR base URL must start with http:// or https://"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "call",
                    "fun": "$",
                    "args": [
                      {
                        "type": "name",
                        "value": ".fhir_config"
                      },
                      {
                        "type": "name",
                        "value": "base_url"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "sub",
                    "args": [
                      {
                        "type": "literal",
                        "value": "/$"
                      },
                      {
                        "type": "literal",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "||",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "auth_url"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "call",
                            "fun": "Sys.getenv",
                            "args": [
                              {
                                "type": "literal",
                                "value": "FHIR_AUTH_URL"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "init_fhir_auth",
                        "args": {
                          "auth_url": {
                            "type": "name",
                            "value": "auth_url"
                          },
                          "client_id": {
                            "type": "name",
                            "value": "client_id"
                          },
                          "client_secret": {
                            "type": "name",
                            "value": "client_secret"
                          }
                        }
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "cache_enabled"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "configure_fhir_cache",
                        "args": {
                          "default_ttl": {
                            "type": "literal",
                            "value": 300
                          },
                          "max_cache_size": {
                            "type": "literal",
                            "value": 100
                          },
                          "enable_compression": {
                            "type": "literal",
                            "value": true
                          }
                        }
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "test_fhir_connection",
                    "args": []
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "message",
                        "args": [
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "FHIR client initialized successfully: %s"
                              },
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": ".fhir_config"
                                  },
                                  {
                                    "type": "name",
                                    "value": "base_url"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": true
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "warning",
                        "args": [
                          {
                            "type": "literal",
                            "value": "FHIR client initialized but connection test failed"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": false
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "test_fhir_connection"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "response"
                          },
                          {
                            "type": "call",
                            "fun": "fhir_request_with_circuit_breaker",
                            "args": {
                              "request_fn": {
                                "type": "call",
                                "fun": "::",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "httr"
                                  },
                                  {
                                    "type": "name",
                                    "value": "GET"
                                  }
                                ]
                              },
                              "url": {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "%s/metadata"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": ".fhir_config"
                                      },
                                      {
                                        "type": "name",
                                        "value": "base_url"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "3": {
                                "type": "call",
                                "fun": ["::", "httr", "add_headers"],
                                "args": {
                                  "Accept": {
                                    "type": "literal",
                                    "value": "application/fhir+json"
                                  }
                                }
                              },
                              "max_retries": {
                                "type": "literal",
                                "value": 1
                              },
                              "timeout": {
                                "type": "literal",
                                "value": 10
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!",
                            "args": [
                              {
                                "type": "call",
                                "fun": "is.null",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "response"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "call",
                                    "fun": ["::", "httr", "content"],
                                    "args": {
                                      "1": {
                                        "type": "name",
                                        "value": "response"
                                      },
                                      "as": {
                                        "type": "literal",
                                        "value": "parsed"
                                      },
                                      "type": {
                                        "type": "literal",
                                        "value": "application/json"
                                      }
                                    }
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "if",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "&&",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "!",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "is.null",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "content"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "resourceType"
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": "==",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "content"
                                              },
                                              {
                                                "type": "name",
                                                "value": "resourceType"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "literal",
                                            "value": "CapabilityStatement"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "message",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "sprintf",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "Connected to FHIR server: %s"
                                              },
                                              {
                                                "type": "call",
                                                "fun": "%||%",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "$",
                                                    "args": [
                                                      {
                                                        "type": "call",
                                                        "fun": "$",
                                                        "args": [
                                                          {
                                                            "type": "name",
                                                            "value": "content"
                                                          },
                                                          {
                                                            "type": "name",
                                                            "value": "software"
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "name"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type": "literal",
                                                    "value": "Unknown"
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": "return",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": true
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": false
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "warning",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "FHIR connection test failed: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "literal",
                                "value": false
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fhir_get_observations"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "NULL", "NULL", "NULL", "TRUE", "FALSE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "||",
                    "args": [
                      {
                        "type": "call",
                        "fun": "||",
                        "args": [
                          {
                            "type": "call",
                            "fun": "missing",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "nzchar",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "patient_id is required and must be non-empty"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": ".fhir_config"
                              },
                              {
                                "type": "name",
                                "value": "base_url"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "FHIR client not initialized. Run init_fhir_client() first."
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "params"
                  },
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "patient": {
                        "type": "name",
                        "value": "patient_id"
                      },
                      "_count": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "default_page_size"
                          }
                        ]
                      }
                    }
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "code"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "name",
                            "value": "code"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              },
                              {
                                "type": "name",
                                "value": "code"
                              }
                            ]
                          },
                          {
                            "type": "name",
                            "value": "code"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "name",
                            "value": "date_from"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              },
                              {
                                "type": "name",
                                "value": "date"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "ge%s"
                              },
                              {
                                "type": "call",
                                "fun": "format_fhir_date",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "date_from"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "name",
                            "value": "date_to"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!",
                            "args": [
                              {
                                "type": "call",
                                "fun": "is.null",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "date_from"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "params"
                                      },
                                      {
                                        "type": "name",
                                        "value": "date"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "%s&date=le%s"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "params"
                                          },
                                          {
                                            "type": "name",
                                            "value": "date"
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": "format_fhir_date",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "date_to"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "params"
                                      },
                                      {
                                        "type": "name",
                                        "value": "date"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "le%s"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "format_fhir_date",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "date_to"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "cache_key"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "obs_%s_%s_%s_%s"
                      },
                      {
                        "type": "name",
                        "value": "patient_id"
                      },
                      {
                        "type": "call",
                        "fun": "%||%",
                        "args": [
                          {
                            "type": "name",
                            "value": "code"
                          },
                          {
                            "type": "literal",
                            "value": "all"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "%||%",
                        "args": [
                          {
                            "type": "name",
                            "value": "date_from"
                          },
                          {
                            "type": "literal",
                            "value": "any"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "%||%",
                        "args": [
                          {
                            "type": "name",
                            "value": "date_to"
                          },
                          {
                            "type": "literal",
                            "value": "any"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "use_cache"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fhir_cached_request",
                            "args": {
                              "cache_key": {
                                "type": "name",
                                "value": "cache_key"
                              },
                              "fetch_fn": {
                                "type": "call",
                                "fun": "function",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "fetch_observations_internal",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "params"
                                          },
                                          {
                                            "type": "name",
                                            "value": "include_all"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              },
                              "ttl": {
                                "type": "literal",
                                "value": 300
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "fetch_observations_internal",
                    "args": [
                      {
                        "type": "name",
                        "value": "params"
                      },
                      {
                        "type": "name",
                        "value": "include_all"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fetch_observations_internal"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "FALSE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "call",
                    "fun": "build_fhir_url",
                    "args": [
                      {
                        "type": "literal",
                        "value": "/Observation"
                      },
                      {
                        "type": "name",
                        "value": "params"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "include_all"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fhir_fetch_all_pages",
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "url"
                              },
                              "max_pages": {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": ".fhir_config"
                                  },
                                  {
                                    "type": "name",
                                    "value": "max_pages"
                                  }
                                ]
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fetch_fhir_bundle",
                            "args": [
                              {
                                "type": "name",
                                "value": "url"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fhir_get_patient"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "TRUE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "||",
                    "args": [
                      {
                        "type": "call",
                        "fun": "||",
                        "args": [
                          {
                            "type": "call",
                            "fun": "missing",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "nzchar",
                            "args": [
                              {
                                "type": "name",
                                "value": "patient_id"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "patient_id is required"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "cache_key"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "patient_%s"
                      },
                      {
                        "type": "name",
                        "value": "patient_id"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "use_cache"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fhir_cached_request",
                            "args": {
                              "cache_key": {
                                "type": "name",
                                "value": "cache_key"
                              },
                              "fetch_fn": {
                                "type": "call",
                                "fun": "function",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  },
                                  {
                                    "type": "call",
                                    "fun": "fetch_patient_internal",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "patient_id"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              },
                              "ttl": {
                                "type": "literal",
                                "value": 3600
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "fetch_patient_internal",
                    "args": [
                      {
                        "type": "name",
                        "value": "patient_id"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fetch_patient_internal"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "%s/Patient/%s"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      },
                      {
                        "type": "name",
                        "value": "patient_id"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "response"
                  },
                  {
                    "type": "call",
                    "fun": "fhir_request_with_circuit_breaker",
                    "args": {
                      "request_fn": {
                        "type": "call",
                        "fun": "::",
                        "args": [
                          {
                            "type": "name",
                            "value": "httr"
                          },
                          {
                            "type": "name",
                            "value": "GET"
                          }
                        ]
                      },
                      "url": {
                        "type": "name",
                        "value": "url"
                      },
                      "3": {
                        "type": "call",
                        "fun": ["::", "httr", "add_headers"],
                        "args": {
                          "Authorization": {
                            "type": "call",
                            "fun": "fhir_auth_header",
                            "args": []
                          },
                          "Accept": {
                            "type": "literal",
                            "value": "application/fhir+json"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.null",
                    "args": [
                      {
                        "type": "name",
                        "value": "response"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "NULL",
                            "value": []
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "content"
                  },
                  {
                    "type": "call",
                    "fun": "safe_parse_json",
                    "args": [
                      {
                        "type": "name",
                        "value": "response"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "content"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "name",
                                    "value": "resourceType"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!=",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "name",
                                    "value": "resourceType"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": "Patient"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "warning",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Expected Patient resource, got %s"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "content"
                                          },
                                          {
                                            "type": "name",
                                            "value": "resourceType"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "name",
                    "value": "content"
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fhir_get_medications"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "active", "TRUE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "||",
                    "args": [
                      {
                        "type": "call",
                        "fun": "missing",
                        "args": [
                          {
                            "type": "name",
                            "value": "patient_id"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "name",
                            "value": "patient_id"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "patient_id is required"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "params"
                  },
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "patient": {
                        "type": "name",
                        "value": "patient_id"
                      },
                      "_count": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "default_page_size"
                          }
                        ]
                      }
                    }
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "status"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "name",
                            "value": "status"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              },
                              {
                                "type": "name",
                                "value": "status"
                              }
                            ]
                          },
                          {
                            "type": "name",
                            "value": "status"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "cache_key"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "meds_%s_%s"
                      },
                      {
                        "type": "name",
                        "value": "patient_id"
                      },
                      {
                        "type": "call",
                        "fun": "%||%",
                        "args": [
                          {
                            "type": "name",
                            "value": "status"
                          },
                          {
                            "type": "literal",
                            "value": "all"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "use_cache"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fhir_cached_request",
                            "args": {
                              "cache_key": {
                                "type": "name",
                                "value": "cache_key"
                              },
                              "fetch_fn": {
                                "type": "call",
                                "fun": "function",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  },
                                  {
                                    "type": "call",
                                    "fun": "fetch_medications_internal",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "params"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              },
                              "ttl": {
                                "type": "literal",
                                "value": 600
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "fetch_medications_internal",
                    "args": [
                      {
                        "type": "name",
                        "value": "params"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fetch_medications_internal"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "call",
                    "fun": "build_fhir_url",
                    "args": [
                      {
                        "type": "literal",
                        "value": "/MedicationStatement"
                      },
                      {
                        "type": "name",
                        "value": "params"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "fetch_fhir_bundle",
                    "args": [
                      {
                        "type": "name",
                        "value": "url"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fhir_fetch_all_pages"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "NULL"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "name",
                            "value": "initial_url"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "initial_url is required"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "max_pages"
                  },
                  {
                    "type": "call",
                    "fun": "%||%",
                    "args": [
                      {
                        "type": "name",
                        "value": "max_pages"
                      },
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "max_pages"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "results"
                  },
                  {
                    "type": "call",
                    "fun": "list",
                    "args": []
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "name",
                    "value": "initial_url"
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "page"
                  },
                  {
                    "type": "literal",
                    "value": 1
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "total_entries"
                  },
                  {
                    "type": "literal",
                    "value": 0
                  }
                ]
              },
              {
                "type": "call",
                "fun": "message",
                "args": [
                  {
                    "type": "literal",
                    "value": "Fetching paginated FHIR results..."
                  }
                ]
              },
              {
                "type": "call",
                "fun": "while",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "url"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<=",
                        "args": [
                          {
                            "type": "name",
                            "value": "page"
                          },
                          {
                            "type": "name",
                            "value": "max_pages"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "getOption",
                            "args": [
                              {
                                "type": "literal",
                                "value": "fhir.verbose"
                              },
                              {
                                "type": "literal",
                                "value": false
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "message",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Fetching page %d"
                                      },
                                      {
                                        "type": "name",
                                        "value": "page"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "bundle"
                          },
                          {
                            "type": "call",
                            "fun": "fetch_fhir_bundle",
                            "args": [
                              {
                                "type": "name",
                                "value": "url"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "bundle"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "warning",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Failed to fetch page %d, stopping pagination"
                                      },
                                      {
                                        "type": "name",
                                        "value": "page"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "break",
                                "args": []
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "&&",
                            "args": [
                              {
                                "type": "call",
                                "fun": "!",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "is.null",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "bundle"
                                          },
                                          {
                                            "type": "name",
                                            "value": "entry"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": ">",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "length",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "bundle"
                                          },
                                          {
                                            "type": "name",
                                            "value": "entry"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "literal",
                                    "value": 0
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "results"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "append",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "results"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "bundle"
                                          },
                                          {
                                            "type": "name",
                                            "value": "entry"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "total_entries"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "+",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "total_entries"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "length",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "bundle"
                                              },
                                              {
                                                "type": "name",
                                                "value": "entry"
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!",
                            "args": [
                              {
                                "type": "call",
                                "fun": "is.null",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "bundle"
                                      },
                                      {
                                        "type": "name",
                                        "value": "total"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "if",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "==",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "page"
                                      },
                                      {
                                        "type": "literal",
                                        "value": 1
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "message",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "sprintf",
                                            "args": [
                                              {
                                                "type": "literal",
                                                "value": "Total results available: %d"
                                              },
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "bundle"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "total"
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "if",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": ">=",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "total_entries"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "bundle"
                                          },
                                          {
                                            "type": "name",
                                            "value": "total"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "break",
                                        "args": []
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "url"
                          },
                          {
                            "type": "call",
                            "fun": "extract_next_url",
                            "args": [
                              {
                                "type": "name",
                                "value": "bundle"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "==",
                            "args": [
                              {
                                "type": "call",
                                "fun": "%%",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "page"
                                  },
                                  {
                                    "type": "literal",
                                    "value": 5
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": 0
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "message",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Fetched %d entries so far..."
                                      },
                                      {
                                        "type": "name",
                                        "value": "total_entries"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "page"
                          },
                          {
                            "type": "call",
                            "fun": "+",
                            "args": [
                              {
                                "type": "name",
                                "value": "page"
                              },
                              {
                                "type": "literal",
                                "value": 1
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": ">",
                        "args": [
                          {
                            "type": "name",
                            "value": "page"
                          },
                          {
                            "type": "name",
                            "value": "max_pages"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "url"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "warning",
                        "args": [
                          {
                            "type": "call",
                            "fun": "sprintf",
                            "args": [
                              {
                                "type": "literal",
                                "value": "Stopped at max_pages limit (%d). More results available."
                              },
                              {
                                "type": "name",
                                "value": "max_pages"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "message",
                "args": [
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "Fetched %d total entries across %d pages"
                      },
                      {
                        "type": "name",
                        "value": "total_entries"
                      },
                      {
                        "type": "call",
                        "fun": "-",
                        "args": [
                          {
                            "type": "name",
                            "value": "page"
                          },
                          {
                            "type": "literal",
                            "value": 1
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "resourceType": {
                        "type": "literal",
                        "value": "Bundle"
                      },
                      "type": {
                        "type": "literal",
                        "value": "searchset"
                      },
                      "total": {
                        "type": "name",
                        "value": "total_entries"
                      },
                      "entry": {
                        "type": "name",
                        "value": "results"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fetch_fhir_bundle"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "response"
                  },
                  {
                    "type": "call",
                    "fun": "fhir_request_with_circuit_breaker",
                    "args": {
                      "request_fn": {
                        "type": "call",
                        "fun": "::",
                        "args": [
                          {
                            "type": "name",
                            "value": "httr"
                          },
                          {
                            "type": "name",
                            "value": "GET"
                          }
                        ]
                      },
                      "url": {
                        "type": "name",
                        "value": "url"
                      },
                      "3": {
                        "type": "call",
                        "fun": ["::", "httr", "add_headers"],
                        "args": {
                          "Authorization": {
                            "type": "call",
                            "fun": "fhir_auth_header",
                            "args": []
                          },
                          "Accept": {
                            "type": "literal",
                            "value": "application/fhir+json"
                          }
                        }
                      },
                      "timeout": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "timeout"
                          }
                        ]
                      }
                    }
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.null",
                    "args": [
                      {
                        "type": "name",
                        "value": "response"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "NULL",
                            "value": []
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "content"
                  },
                  {
                    "type": "call",
                    "fun": "safe_parse_json",
                    "args": [
                      {
                        "type": "name",
                        "value": "response"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "name",
                            "value": "content"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "name",
                                    "value": "resourceType"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "warning",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Response missing resourceType"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!=",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "name",
                                    "value": "resourceType"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": "Bundle"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "warning",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "Expected Bundle, got %s"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "content"
                                          },
                                          {
                                            "type": "name",
                                            "value": "resourceType"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "call",
                                "fun": "$",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "content"
                                  },
                                  {
                                    "type": "name",
                                    "value": "entry"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "content"
                                      },
                                      {
                                        "type": "name",
                                        "value": "entry"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "list",
                                    "args": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "name",
                    "value": "content"
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "build_fhir_url"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "NULL"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "grepl",
                        "args": [
                          {
                            "type": "literal",
                            "value": "^/"
                          },
                          {
                            "type": "name",
                            "value": "path"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "path"
                          },
                          {
                            "type": "call",
                            "fun": "paste0",
                            "args": [
                              {
                                "type": "literal",
                                "value": "/"
                              },
                              {
                                "type": "name",
                                "value": "path"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "call",
                    "fun": "paste0",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      },
                      {
                        "type": "name",
                        "value": "path"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "&&",
                    "args": [
                      {
                        "type": "call",
                        "fun": "!",
                        "args": [
                          {
                            "type": "call",
                            "fun": "is.null",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": ">",
                        "args": [
                          {
                            "type": "call",
                            "fun": "length",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              }
                            ]
                          },
                          {
                            "type": "literal",
                            "value": 0
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "params"
                          },
                          {
                            "type": "call",
                            "fun": "[",
                            "args": [
                              {
                                "type": "name",
                                "value": "params"
                              },
                              {
                                "type": "call",
                                "fun": "!",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sapply",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "params"
                                      },
                                      {
                                        "type": "name",
                                        "value": "is.null"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": ">",
                            "args": [
                              {
                                "type": "call",
                                "fun": "length",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "params"
                                  }
                                ]
                              },
                              {
                                "type": "literal",
                                "value": 0
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "query_string"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "paste",
                                    "args": {
                                      "1": {
                                        "type": "call",
                                        "fun": "mapply",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "function",
                                            "args": [
                                              {
                                                "type": "pairlist",
                                                "value": ["", ""]
                                              },
                                              {
                                                "type": "call",
                                                "fun": "{",
                                                "args": [
                                                  {
                                                    "type": "call",
                                                    "fun": "sprintf",
                                                    "args": [
                                                      {
                                                        "type": "literal",
                                                        "value": "%s=%s"
                                                      },
                                                      {
                                                        "type": "name",
                                                        "value": "key"
                                                      },
                                                      {
                                                        "type": "call",
                                                        "fun": ["::", "utils", "URLencode"],
                                                        "args": [
                                                          {
                                                            "type": "call",
                                                            "fun": "as.character",
                                                            "args": [
                                                              {
                                                                "type": "name",
                                                                "value": "value"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "NULL",
                                                "value": []
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "names",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "params"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "name",
                                            "value": "params"
                                          }
                                        ]
                                      },
                                      "collapse": {
                                        "type": "literal",
                                        "value": "&"
                                      }
                                    }
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "url"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "%s?%s"
                                      },
                                      {
                                        "type": "name",
                                        "value": "url"
                                      },
                                      {
                                        "type": "name",
                                        "value": "query_string"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "extract_next_url"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "is.null",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "bundle"
                              },
                              {
                                "type": "name",
                                "value": "link"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "for",
                        "args": [
                          {
                            "type": "name",
                            "value": "link"
                          },
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "bundle"
                              },
                              {
                                "type": "name",
                                "value": "link"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "if",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "&&",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "!",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "is.null",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "link"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "relation"
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": "==",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "link"
                                              },
                                              {
                                                "type": "name",
                                                "value": "relation"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "literal",
                                            "value": "next"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "return",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "link"
                                              },
                                              {
                                                "type": "name",
                                                "value": "url"
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "NULL",
                    "value": []
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "safe_parse_json"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "tryCatch",
                "args": {
                  "1": {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "name",
                            "value": "content"
                          },
                          {
                            "type": "call",
                            "fun": ["::", "httr", "content"],
                            "args": {
                              "1": {
                                "type": "name",
                                "value": "response"
                              },
                              "as": {
                                "type": "literal",
                                "value": "parsed"
                              },
                              "type": {
                                "type": "literal",
                                "value": "application/json"
                              },
                              "encoding": {
                                "type": "literal",
                                "value": "UTF-8"
                              }
                            }
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "&&",
                            "args": [
                              {
                                "type": "call",
                                "fun": "!",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "is.null",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "content"
                                          },
                                          {
                                            "type": "name",
                                            "value": "resourceType"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "==",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "content"
                                      },
                                      {
                                        "type": "name",
                                        "value": "resourceType"
                                      }
                                    ]
                                  },
                                  {
                                    "type": "literal",
                                    "value": "OperationOutcome"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "issues"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "extract_operation_outcome_issues",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "content"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "warning",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "sprintf",
                                    "args": [
                                      {
                                        "type": "literal",
                                        "value": "FHIR OperationOutcome: %s"
                                      },
                                      {
                                        "type": "call",
                                        "fun": "paste",
                                        "args": {
                                          "1": {
                                            "type": "name",
                                            "value": "issues"
                                          },
                                          "collapse": {
                                            "type": "literal",
                                            "value": "; "
                                          }
                                        }
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "name",
                            "value": "content"
                          }
                        ]
                      }
                    ]
                  },
                  "error": {
                    "type": "call",
                    "fun": "function",
                    "args": [
                      {
                        "type": "pairlist",
                        "value": ""
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "warning",
                            "args": [
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Failed to parse FHIR response: %s"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "$",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "e"
                                      },
                                      {
                                        "type": "name",
                                        "value": "message"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "<-",
                            "args": [
                              {
                                "type": "name",
                                "value": "raw_content"
                              },
                              {
                                "type": "call",
                                "fun": "tryCatch",
                                "args": {
                                  "1": {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": ["::", "httr", "content"],
                                        "args": {
                                          "1": {
                                            "type": "name",
                                            "value": "response"
                                          },
                                          "as": {
                                            "type": "literal",
                                            "value": "text"
                                          },
                                          "encoding": {
                                            "type": "literal",
                                            "value": "UTF-8"
                                          }
                                        }
                                      }
                                    ]
                                  },
                                  "error": {
                                    "type": "call",
                                    "fun": "function",
                                    "args": [
                                      {
                                        "type": "pairlist",
                                        "value": ""
                                      },
                                      {
                                        "type": "call",
                                        "fun": "{",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "Unable to retrieve raw content"
                                          }
                                        ]
                                      },
                                      {
                                        "type": "NULL",
                                        "value": []
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "if",
                            "args": [
                              {
                                "type": "call",
                                "fun": "getOption",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "fhir.debug"
                                  },
                                  {
                                    "type": "literal",
                                    "value": false
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "{",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "message",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "sprintf",
                                        "args": [
                                          {
                                            "type": "literal",
                                            "value": "Raw response: %s"
                                          },
                                          {
                                            "type": "call",
                                            "fun": "substr",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "raw_content"
                                              },
                                              {
                                                "type": "literal",
                                                "value": 1
                                              },
                                              {
                                                "type": "literal",
                                                "value": 500
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "NULL",
                                "value": []
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "NULL",
                        "value": []
                      }
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "extract_operation_outcome_issues"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.null",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "outcome"
                          },
                          {
                            "type": "name",
                            "value": "issue"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "literal",
                            "value": "Unknown error"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "issues"
                  },
                  {
                    "type": "call",
                    "fun": "sapply",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "outcome"
                          },
                          {
                            "type": "name",
                            "value": "issue"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "function",
                        "args": [
                          {
                            "type": "pairlist",
                            "value": ""
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "severity"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "%||%",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "issue"
                                          },
                                          {
                                            "type": "name",
                                            "value": "severity"
                                          }
                                        ]
                                      },
                                      {
                                        "type": "literal",
                                        "value": "error"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "code"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "%||%",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "$",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "issue"
                                          },
                                          {
                                            "type": "name",
                                            "value": "code"
                                          }
                                        ]
                                      },
                                      {
                                        "type": "literal",
                                        "value": "unknown"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "<-",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "diagnostics"
                                  },
                                  {
                                    "type": "call",
                                    "fun": "%||%",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "%||%",
                                        "args": [
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "name",
                                                "value": "issue"
                                              },
                                              {
                                                "type": "name",
                                                "value": "diagnostics"
                                              }
                                            ]
                                          },
                                          {
                                            "type": "call",
                                            "fun": "$",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "$",
                                                "args": [
                                                  {
                                                    "type": "name",
                                                    "value": "issue"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "details"
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "name",
                                                "value": "text"
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "literal",
                                        "value": "No details"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "sprintf",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "[%s] %s: %s"
                                  },
                                  {
                                    "type": "name",
                                    "value": "severity"
                                  },
                                  {
                                    "type": "name",
                                    "value": "code"
                                  },
                                  {
                                    "type": "name",
                                    "value": "diagnostics"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "NULL",
                            "value": []
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "name",
                    "value": "issues"
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "format_fhir_date"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ""
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.character",
                    "args": [
                      {
                        "type": "name",
                        "value": "date"
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "name",
                            "value": "date"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "if",
                    "args": [
                      {
                        "type": "call",
                        "fun": "inherits",
                        "args": [
                          {
                            "type": "name",
                            "value": "date"
                          },
                          {
                            "type": "literal",
                            "value": "Date"
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "return",
                            "args": [
                              {
                                "type": "call",
                                "fun": "format",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "date"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "%Y-%m-%d"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "type": "call",
                        "fun": "if",
                        "args": [
                          {
                            "type": "call",
                            "fun": "||",
                            "args": [
                              {
                                "type": "call",
                                "fun": "inherits",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "date"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "POSIXct"
                                  }
                                ]
                              },
                              {
                                "type": "call",
                                "fun": "inherits",
                                "args": [
                                  {
                                    "type": "name",
                                    "value": "date"
                                  },
                                  {
                                    "type": "literal",
                                    "value": "POSIXlt"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "return",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "format",
                                    "args": [
                                      {
                                        "type": "name",
                                        "value": "date"
                                      },
                                      {
                                        "type": "literal",
                                        "value": "%Y-%m-%dT%H:%M:%S"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "{",
                            "args": [
                              {
                                "type": "call",
                                "fun": "stop",
                                "args": [
                                  {
                                    "type": "literal",
                                    "value": "Date must be character, Date, or POSIXct/POSIXlt"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "fhir_search"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", "list()", "TRUE"]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "!",
                    "args": [
                      {
                        "type": "call",
                        "fun": "nzchar",
                        "args": [
                          {
                            "type": "name",
                            "value": "resource_type"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "stop",
                        "args": [
                          {
                            "type": "literal",
                            "value": "resource_type is required"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.null",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": "search_params"
                          },
                          {
                            "type": "name",
                            "value": "_count"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "<-",
                        "args": [
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": "search_params"
                              },
                              {
                                "type": "name",
                                "value": "_count"
                              }
                            ]
                          },
                          {
                            "type": "call",
                            "fun": "$",
                            "args": [
                              {
                                "type": "name",
                                "value": ".fhir_config"
                              },
                              {
                                "type": "name",
                                "value": "default_page_size"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "cache_key"
                  },
                  {
                    "type": "call",
                    "fun": "sprintf",
                    "args": [
                      {
                        "type": "literal",
                        "value": "search_%s_%s"
                      },
                      {
                        "type": "name",
                        "value": "resource_type"
                      },
                      {
                        "type": "call",
                        "fun": ["::", "digest", "digest"],
                        "args": [
                          {
                            "type": "name",
                            "value": "search_params"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "name",
                    "value": "use_cache"
                  },
                  {
                    "type": "call",
                    "fun": "{",
                    "args": [
                      {
                        "type": "call",
                        "fun": "return",
                        "args": [
                          {
                            "type": "call",
                            "fun": "fhir_cached_request",
                            "args": {
                              "cache_key": {
                                "type": "name",
                                "value": "cache_key"
                              },
                              "fetch_fn": {
                                "type": "call",
                                "fun": "function",
                                "args": [
                                  {
                                    "type": "NULL",
                                    "value": []
                                  },
                                  {
                                    "type": "call",
                                    "fun": "{",
                                    "args": [
                                      {
                                        "type": "call",
                                        "fun": "<-",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "url"
                                          },
                                          {
                                            "type": "call",
                                            "fun": "build_fhir_url",
                                            "args": [
                                              {
                                                "type": "call",
                                                "fun": "sprintf",
                                                "args": [
                                                  {
                                                    "type": "literal",
                                                    "value": "/%s"
                                                  },
                                                  {
                                                    "type": "name",
                                                    "value": "resource_type"
                                                  }
                                                ]
                                              },
                                              {
                                                "type": "name",
                                                "value": "search_params"
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "type": "call",
                                        "fun": "fetch_fhir_bundle",
                                        "args": [
                                          {
                                            "type": "name",
                                            "value": "url"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "type": "NULL",
                                    "value": []
                                  }
                                ]
                              },
                              "ttl": {
                                "type": "literal",
                                "value": 300
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "<-",
                "args": [
                  {
                    "type": "name",
                    "value": "url"
                  },
                  {
                    "type": "call",
                    "fun": "build_fhir_url",
                    "args": [
                      {
                        "type": "call",
                        "fun": "sprintf",
                        "args": [
                          {
                            "type": "literal",
                            "value": "/%s"
                          },
                          {
                            "type": "name",
                            "value": "resource_type"
                          }
                        ]
                      },
                      {
                        "type": "name",
                        "value": "search_params"
                      }
                    ]
                  }
                ]
              },
              {
                "type": "call",
                "fun": "return",
                "args": [
                  {
                    "type": "call",
                    "fun": "fetch_fhir_bundle",
                    "args": [
                      {
                        "type": "name",
                        "value": "url"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "get_fhir_status"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "NULL",
            "value": []
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "list",
                "args": {
                  "base_url": {
                    "type": "call",
                    "fun": "$",
                    "args": [
                      {
                        "type": "name",
                        "value": ".fhir_config"
                      },
                      {
                        "type": "name",
                        "value": "base_url"
                      }
                    ]
                  },
                  "initialized": {
                    "type": "call",
                    "fun": "nzchar",
                    "args": [
                      {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "base_url"
                          }
                        ]
                      }
                    ]
                  },
                  "authenticated": {
                    "type": "call",
                    "fun": "tryCatch",
                    "args": {
                      "1": {
                        "type": "call",
                        "fun": "{",
                        "args": [
                          {
                            "type": "call",
                            "fun": "!",
                            "args": [
                              {
                                "type": "call",
                                "fun": "is.null",
                                "args": [
                                  {
                                    "type": "call",
                                    "fun": "get_token_info",
                                    "args": []
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      "error": {
                        "type": "call",
                        "fun": "function",
                        "args": [
                          {
                            "type": "pairlist",
                            "value": ""
                          },
                          {
                            "type": "literal",
                            "value": false
                          },
                          {
                            "type": "NULL",
                            "value": []
                          }
                        ]
                      }
                    }
                  },
                  "circuit_breaker": {
                    "type": "call",
                    "fun": "get_fhir_circuit_status",
                    "args": []
                  },
                  "cache": {
                    "type": "call",
                    "fun": "get_cache_stats",
                    "args": []
                  },
                  "config": {
                    "type": "call",
                    "fun": "list",
                    "args": {
                      "default_page_size": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "default_page_size"
                          }
                        ]
                      },
                      "max_pages": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "max_pages"
                          }
                        ]
                      },
                      "timeout": {
                        "type": "call",
                        "fun": "$",
                        "args": [
                          {
                            "type": "name",
                            "value": ".fhir_config"
                          },
                          {
                            "type": "name",
                            "value": "timeout"
                          }
                        ]
                      }
                    }
                  }
                }
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  },
  {
    "type": "call",
    "fun": "<-",
    "args": [
      {
        "type": "name",
        "value": "%||%"
      },
      {
        "type": "call",
        "fun": "function",
        "args": [
          {
            "type": "pairlist",
            "value": ["", ""]
          },
          {
            "type": "call",
            "fun": "{",
            "args": [
              {
                "type": "call",
                "fun": "if",
                "args": [
                  {
                    "type": "call",
                    "fun": "is.null",
                    "args": [
                      {
                        "type": "name",
                        "value": "x"
                      }
                    ]
                  },
                  {
                    "type": "name",
                    "value": "y"
                  },
                  {
                    "type": "name",
                    "value": "x"
                  }
                ]
              }
            ]
          },
          {
            "type": "NULL",
            "value": []
          }
        ]
      }
    ]
  }
]
